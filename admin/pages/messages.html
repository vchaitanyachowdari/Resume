<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Messages â€” VC Admin</title>
    <meta name="robots" content="noindex, nofollow" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="../css/admin.css" />
</head>

<body>
    <div class="admin-shell">
        <div id="sidebarMount"></div>
        <div class="main-wrapper">
            <header class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn" style="display:none" id="mobileSidebarBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <line x1="3" y1="6" x2="21" y2="6" />
                            <line x1="3" y1="12" x2="21" y2="12" />
                            <line x1="3" y1="18" x2="21" y2="18" />
                        </svg>
                    </button>
                    <div>
                        <h2 class="page-title">Messages</h2>
                        <div class="breadcrumb">Dashboard <span>â€º</span> Messages</div>
                    </div>
                </div>
                <div class="topbar-right">
                    <button class="topbar-btn" id="themeToggle"><span class="theme-icon">â˜€ï¸</span></button>
                    <div class="topbar-user" data-dropdown="topDrop" style="position:relative">
                        <div class="user-avatar" style="width:30px;height:30px;font-size:12px"><span
                                class="user-initials">VC</span></div>
                        <span class="topbar-user-name user-display-name">V Chaitanya</span>
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="6 9 12 15 18 9" />
                        </svg>
                        <div class="dropdown-menu" id="topDrop">
                            <div class="dropdown-item danger" data-logout>ğŸšª Logout</div>
                        </div>
                    </div>
                </div>
            </header>

            <main class="page-content">
                <div class="page-header">
                    <div class="page-header-left">
                        <h1>Messages Inbox</h1>
                        <p>Contact form submissions from your portfolio</p>
                    </div>
                    <div class="page-header-actions">
                        <button class="btn btn-secondary btn-sm" onclick="markAllRead()">âœ… Mark All Read</button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab-btn active" data-tab="all" onclick="filterMessages('all',this)">All <span
                            id="countAll" class="badge badge-gray" style="margin-left:6px"></span></button>
                    <button class="tab-btn" data-tab="unread" onclick="filterMessages('unread',this)">Unread <span
                            id="countUnread" class="badge badge-red" style="margin-left:6px"></span></button>
                    <button class="tab-btn" data-tab="read" onclick="filterMessages('read',this)">Read <span
                            id="countRead" class="badge badge-gray" style="margin-left:6px"></span></button>
                </div>

                <div class="card" style="padding:0;overflow:hidden">
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Sender</th>
                                    <th>Subject</th>
                                    <th>Preview</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="msgTbody"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- VIEW MESSAGE MODAL -->
    <div class="modal-overlay" id="viewMsgModal">
        <div class="modal" style="max-width:580px">
            <div class="modal-header">
                <h3 class="modal-title" id="msgSubject">Message</h3>
                <button class="modal-close" onclick="Modal.hide('viewMsgModal')">âœ•</button>
            </div>
            <div class="modal-body">
                <div
                    style="display:flex;align-items:center;gap:14px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--border-subtle)">
                    <div class="user-avatar" id="msgAvatar" style="width:44px;height:44px;font-size:16px">?</div>
                    <div>
                        <div style="font-weight:700;font-size:15px;color:var(--text-primary)" id="msgName"></div>
                        <a style="color:var(--accent-primary);font-size:13px" id="msgEmail" href="#"></a>
                    </div>
                    <div style="margin-left:auto;font-size:12px;color:var(--text-muted)" id="msgDate"></div>
                </div>
                <p style="font-size:14px;color:var(--text-primary);line-height:1.7" id="msgBody"></p>
            </div>
            <div class="modal-footer" style="justify-content:space-between">
                <button class="btn btn-danger btn-sm" id="msgDeleteBtn">ğŸ—‘ï¸ Delete</button>
                <div style="display:flex;gap:8px">
                    <button class="btn btn-secondary" id="msgToggleBtn"></button>
                    <a class="btn btn-primary" id="msgReplyBtn" href="#">âœ‰ï¸ Reply</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmModal">
        <div class="modal modal-sm">
            <div class="modal-body" style="text-align:center;padding-top:32px">
                <div class="confirm-icon">ğŸ—‘ï¸</div>
                <div class="confirm-title">Delete Message?</div>
                <p class="confirm-text">This message will be permanently deleted.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.hide('confirmModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <script src="../js/admin.js"></script>
    <script src="../js/sidebar.js"></script>
    <script>
        Auth.requireAuth('../login.html');
        initPage();

        let currentFilter = 'all';
        let viewingId = null;
        let deleteId = null;

        function getMessages() { return CMS.get('messages'); }
        function updateCounts() {
            const msgs = getMessages();
            document.getElementById('countAll').textContent = msgs.length;
            document.getElementById('countUnread').textContent = msgs.filter(m => m.status === 'unread').length;
            document.getElementById('countRead').textContent = msgs.filter(m => m.status === 'read').length;
        }

        function renderMessages(filter) {
            let msgs = getMessages();
            if (filter !== 'all') msgs = msgs.filter(m => m.status === filter);
            updateCounts();
            const tbody = document.getElementById('msgTbody');
            if (!msgs.length) {
                tbody.innerHTML = `<tr><td colspan="6"><div class="empty-state"><div class="empty-icon">ğŸ’¬</div><div class="empty-title">No messages</div></div></td></tr>`;
                return;
            }
            tbody.innerHTML = msgs.map(m => `
      <tr style="${m.status === 'unread' ? 'background:rgba(99,102,241,0.04)' : ''}" id="row-${m.id}">
        <td>
          <div style="display:flex;align-items:center;gap:10px">
            <div class="user-avatar" style="width:32px;height:32px;font-size:12px">${m.name[0]}</div>
            <div>
              <div style="font-weight:${m.status === 'unread' ? '700' : '500'};font-size:13px;color:var(--text-primary)">${escapeHtml(m.name)}</div>
              <div style="font-size:11px;color:var(--text-muted)">${m.email}</div>
            </div>
          </div>
        </td>
        <td style="font-weight:${m.status === 'unread' ? '600' : '400'};font-size:13px">${escapeHtml(m.subject)}</td>
        <td style="color:var(--text-muted);font-size:12px;max-width:200px">
          <div style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(m.message.substring(0, 80))}...</div>
        </td>
        <td class="td-muted">${timeAgo(m.date)}</td>
        <td><span class="badge ${m.status === 'unread' ? 'badge-red' : 'badge-gray'}">${m.status === 'unread' ? 'â— Unread' : 'Read'}</span></td>
        <td>
          <div class="td-actions">
            <button class="btn btn-primary btn-sm" onclick="viewMsg(${m.id})">View</button>
            <button class="btn btn-danger btn-icon btn-sm" onclick="deleteMsg(${m.id})" title="Delete">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M9 6V4h6v2"/></svg>
            </button>
          </div>
        </td>
      </tr>
    `).join('');
        }

        renderMessages('all');

        function filterMessages(tab, btn) {
            currentFilter = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderMessages(tab);
        }

        function viewMsg(id) {
            viewingId = id;
            const m = getMessages().find(x => x.id === id);
            if (!m) return;
            // Mark as read
            CMS.update('messages', id, { status: 'read' });
            document.getElementById('msgSubject').textContent = m.subject;
            document.getElementById('msgAvatar').textContent = m.name[0];
            document.getElementById('msgName').textContent = m.name;
            const emailEl = document.getElementById('msgEmail');
            emailEl.textContent = m.email; emailEl.href = `mailto:${m.email}`;
            document.getElementById('msgDate').textContent = formatDate(m.date);
            document.getElementById('msgBody').textContent = m.message;
            document.getElementById('msgReplyBtn').href = `mailto:${m.email}?subject=Re: ${m.subject}`;
            document.getElementById('msgToggleBtn').textContent = 'ğŸ“– Mark Unread';
            Modal.show('viewMsgModal');
            renderMessages(currentFilter);
            updateCounts();
        }

        document.getElementById('msgToggleBtn').addEventListener('click', () => {
            if (!viewingId) return;
            const m = getMessages().find(x => x.id === viewingId);
            const newStatus = m.status === 'read' ? 'unread' : 'read';
            CMS.update('messages', viewingId, { status: newStatus });
            Modal.hide('viewMsgModal');
            Toast.success(`Marked as ${newStatus}`);
            renderMessages(currentFilter);
            updateCounts();
        });

        document.getElementById('msgDeleteBtn').addEventListener('click', () => {
            deleteId = viewingId;
            Modal.hide('viewMsgModal');
            Modal.show('confirmModal');
        });

        function deleteMsg(id) { deleteId = id; Modal.show('confirmModal'); }

        document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
            CMS.remove('messages', deleteId);
            Modal.hide('confirmModal');
            Toast.success('Message deleted');
            renderMessages(currentFilter);
            updateCounts();
        });

        function markAllRead() {
            let msgs = getMessages();
            msgs.forEach(m => m.status = 'read');
            CMS.set('messages', msgs);
            renderMessages(currentFilter);
            updateCounts();
            Toast.success('All messages marked as read');
        }

        function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    </script>
</body>

</html>